<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deriv EMA Cross + Sell Alerts Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #eee; }
  h1 { text-align: center; color: #0ff; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
  .card { background: #222; padding: 10px; border-radius: 6px; position: relative; }
  .symbol { font-weight: bold; font-size: 1.2em; }
  canvas { width: 100%; height: 100px; background: #000; }
  .flash-up { animation: flashGreen 0.5s; }
  .flash-down { animation: flashRed 0.5s; }
  @keyframes flashGreen { from { background: #0f0; } to { background: #222; } }
  @keyframes flashRed { from { background: #f00; } to { background: #222; } }
  #alerts { background: #000; padding: 10px; margin: 10px; border-radius: 6px; }
  .alert { font-size: 1.2em; font-weight: bold; margin-top: 5px; }
  .sell { color: red; }
  .exit { color: orange; }
  #controls { text-align: center; margin: 10px; }
  button { padding: 8px 16px; font-size: 1em; }
</style>
</head>
<body>
<h1>EMA Cross Dashboard with SELL/EXIT Alerts + Sounds</h1>

<div id="controls">
  <button onclick="connectWS()">üîê Login to Deriv</button>
  <span id="loginStatus" style="margin-left:10px;"></span>
</div>

<div id="alerts"></div>
<div id="dashboard" class="grid"></div>

<!-- Sound files -->
<audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="exitSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
let ws;
const app_id = 99120; // Your Deriv App ID
const emaFastPeriod = 5;
const emaSlowPeriod = 20;
const stopLossPct = 0.3; // % drop from last high before triggering exit

const symbols = [];
const charts = {};
const prices = {};
const emas = {};
const lastHigh = {};

function ema(prevEMA, price, period) {
    const k = 2 / (period + 1);
    return prevEMA == null ? price : price * k + prevEMA * (1 - k);
}

function createCard(symbol) {
    const card = document.createElement('div');
    card.className = 'card';
    card.id = `card-${symbol}`;
    card.innerHTML = `<div class="symbol">${symbol}</div><canvas id="chart-${symbol}"></canvas>`;
    document.getElementById('dashboard').appendChild(card);
    const ctx = document.getElementById(`chart-${symbol}`).getContext('2d');
    charts[symbol] = { ctx, data: [] };
}

function drawChart(symbol) {
    const { ctx, data } = charts[symbol];
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.strokeStyle = '#0f0';
    ctx.beginPath();
    data.forEach((p, i) => {
        const x = (i / data.length) * ctx.canvas.width;
        const y = ctx.canvas.height - ((p - Math.min(...data)) / (Math.max(...data) - Math.min(...data))) * ctx.canvas.height;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.stroke();
}

function flashCard(symbol, direction) {
    const card = document.getElementById(`card-${symbol}`);
    card.classList.add(direction === 'up' ? 'flash-up' : 'flash-down');
    setTimeout(() => card.classList.remove('flash-up', 'flash-down'), 500);
}

function showAlert(symbol, type) {
    const alertsDiv = document.getElementById('alerts');
    const div = document.createElement('div');
    div.className = `alert ${type}`;
    div.textContent = `${symbol} ‚Üí ${type === 'sell' ? 'SELL NOW' : 'EXIT TO AVOID LOSS'}`;
    alertsDiv.prepend(div);

    // Play sound
    if (type === 'sell') document.getElementById('sellSound').play();
    if (type === 'exit') document.getElementById('exitSound').play();
}

function connectWS() {
    ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);

    ws.onopen = () => {
        ws.send(JSON.stringify({ active_symbols: 'brief', product_type: 'basic' }));
    };

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);

        if (data.error) {
            document.getElementById('loginStatus').textContent = "‚ùå Error: " + data.error.message;
            return;
        }

        if (data.active_symbols) {
            document.getElementById('loginStatus').textContent = "‚úÖ Connected";
            data.active_symbols
                .filter(s => s.symbol.includes('VOLATILITY') && s.symbol.includes('ACCUMULATOR'))
                .forEach(s => {
                    if (!symbols.includes(s.symbol)) {
                        symbols.push(s.symbol);
                        createCard(s.symbol);
                        ws.send(JSON.stringify({ ticks: s.symbol, subscribe: 1 }));
                    }
                });
        }

        if (data.tick) {
            const { symbol, quote } = data.tick;
            if (!prices[symbol]) prices[symbol] = [];
            prices[symbol].push(quote);
            if (prices[symbol].length > 200) prices[symbol].shift();

            if (!emas[symbol]) emas[symbol] = { fast: null, slow: null, prevFast: null, prevSlow: null };
            emas[symbol].prevFast = emas[symbol].fast;
            emas[symbol].prevSlow = emas[symbol].slow;
            emas[symbol].fast = ema(emas[symbol].fast, quote, emaFastPeriod);
            emas[symbol].slow = ema(emas[symbol].slow, quote, emaSlowPeriod);

            // Track last high for stop-loss
            if (!lastHigh[symbol] || quote > lastHigh[symbol]) lastHigh[symbol] = quote;

            // EMA cross SELL signal
            if (emas[symbol].prevFast > emas[symbol].prevSlow && emas[symbol].fast < emas[symbol].slow) {
                flashCard(symbol, 'down');
                showAlert(symbol, 'sell');
            }

            // Stop-loss EXIT signal
            if (lastHigh[symbol] && ((lastHigh[symbol] - quote) / lastHigh[symbol]) * 100 >= stopLossPct) {
                showAlert(symbol, 'exit');
                lastHigh[symbol] = quote; // reset after exit
            }

            // Update chart
            charts[symbol].data = prices[symbol];
            drawChart(symbol);
        }
    };
}
</script>
</body>
</html>
