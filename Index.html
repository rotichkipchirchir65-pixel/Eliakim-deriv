<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deriv EMA Cross + Sell/Exit Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 0; }
    h1 { text-align: center; color: #0ff; margin: 20px 0; }
    #controls { text-align: center; margin-bottom: 10px; }
    #controls button { padding: 8px 16px; font-size: 1em; cursor: pointer; }
    #loginStatus { margin-left: 10px; font-size: 1em; vertical-align: middle; }
    #alerts { background: #000; padding: 10px; max-height: 150px; overflow-y: auto; }
    .alert { font-size: 1.2em; font-weight: bold; margin: 5px 0; }
    .sell { color: #f55; }
    .exit { color: #fa0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 10px; }
    .card { background: #222; border-radius: 6px; padding: 10px; position: relative; }
    .symbol { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
    canvas { width: 100%; height: 100px; display: block; background: #000; }
    .flash-up { animation: flashGreen 0.5s; }
    .flash-down { animation: flashRed 0.5s; }
    @keyframes flashGreen { from { background: #0f0; } to { background: #222; } }
    @keyframes flashRed   { from { background: #f00; } to { background: #222; } }
  </style>
</head>
<body>
  <h1>EMA Cross Dashboard with SELL/EXIT Alerts</h1>
  <div id="controls">
    <button id="loginBtn">üîê Login to Deriv</button>
    <span id="loginStatus"></span>
  </div>
  <div id="alerts"></div>
  <div id="dashboard" class="grid"></div>

  <audio id="sellSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <audio id="exitSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script>
  (function() {
    const app_id = 99120;                // your Deriv App ID
    const emaFastPeriod = 5;
    const emaSlowPeriod = 20;
    const stopLossPct = 0.3;             // % drop from last high before EXIT

    let ws;
    const symbols = [];
    const charts = {};
    const prices = {};
    const emas = {};
    const lastHigh = {};

    function ema(prevEMA, price, period) {
      const k = 2 / (period + 1);
      return prevEMA == null ? price : price * k + prevEMA * (1 - k);
    }

    function createCard(symbol) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'card-' + symbol;
      card.innerHTML =
        `<div class="symbol">${symbol}</div>
         <canvas id="chart-${symbol}"></canvas>`;
      document.getElementById('dashboard').appendChild(card);
      const ctx = document.getElementById('chart-' + symbol).getContext('2d');
      charts[symbol] = { ctx, data: [] };
    }

    function drawChart(symbol) {
      const { ctx, data } = charts[symbol];
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      if (!data.length) return;
      const min = Math.min(...data);
      const max = Math.max(...data);
      ctx.strokeStyle = '#0f0';
      ctx.beginPath();
      data.forEach((p, i) => {
        const x = (i / (data.length - 1)) * ctx.canvas.width;
        const y = ctx.canvas.height - ((p - min) / (max - min)) * ctx.canvas.height;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function flashCard(symbol, dir) {
      const card = document.getElementById('card-' + symbol);
      card.classList.add(dir === 'up' ? 'flash-up' : 'flash-down');
      setTimeout(() => card.classList.remove('flash-up','flash-down'), 500);
    }

    function showAlert(symbol, type) {
      const div = document.createElement('div');
      div.className = 'alert ' + type;
      div.textContent = symbol + ' ‚Üí ' + (type === 'sell' ? 'SELL NOW' : 'EXIT TO AVOID LOSS');
      document.getElementById('alerts').prepend(div);
      (type === 'sell' ? document.getElementById('sellSound') : document.getElementById('exitSound')).play();
    }

    function connectWS(token) {
      ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=' + app_id);

      ws.onopen = () => {
        document.getElementById('loginStatus').textContent = 'Connecting‚Ä¶';
        if (token) {
          ws.send(JSON.stringify({ authorize: token }));
        }
        ws.send(JSON.stringify({ active_symbols: 'brief', product_type: 'basic' }));
      };

      ws.onerror = err => {
        document.getElementById('loginStatus').textContent = 'WS Error';
        console.error(err);
      };

      ws.onmessage = msg => {
        const data = JSON.parse(msg.data);
        if (data.error) {
          document.getElementById('loginStatus').textContent = '‚ùå ' + data.error.message;
          return;
        }
        if (data.authorize) {
          document.getElementById('loginStatus').textContent = '‚úÖ Logged in as ' + data.authorize.loginid;
        }
        if (data.active_symbols) {
          document.getElementById('loginStatus').textContent = '‚úÖ Connected';
          data.active_symbols
            .filter(s => s.symbol.includes('ACCUMULATOR'))
            .forEach(s => {
              const sym = s.symbol;
              if (!symbols.includes(sym)) {
                symbols.push(sym);
                createCard(sym);
                ws.send(JSON.stringify({ ticks: sym, subscribe: 1 }));
              }
            });
        }
        if (data.tick) {
          const { symbol, quote } = data.tick;
          if (!prices[symbol]) prices[symbol] = [];
          prices[symbol].push(quote);
          if (prices[symbol].length > 100) prices[symbol].shift();

          if (!emas[symbol]) {
            emas[symbol] = { fast: null, slow: null, prevFast: null, prevSlow: null };
          }
          emas[symbol].prevFast = emas[symbol].fast;
          emas[symbol].prevSlow = emas[symbol].slow;
          emas[symbol].fast = ema(emas[symbol].fast, quote, emaFastPeriod);
          emas[symbol].slow = ema(emas[symbol].slow, quote, emaSlowPeriod);

          // track last high for stop-loss
          if (!lastHigh[symbol] || quote > lastHigh[symbol]) {
            lastHigh[symbol] = quote;
          }

          // EMA cross SELL
          if (emas[symbol].prevFast > emas[symbol].prevSlow && emas[symbol].fast < emas[symbol].slow) {
            flashCard(symbol, 'down');
            showAlert(symbol, 'sell');
          }

          // stop-loss EXIT
          if (((lastHigh[symbol] - quote) / lastHigh[symbol]) * 100 >= stopLossPct) {
            flashCard(symbol, 'down');
            showAlert(symbol, 'exit');
            lastHigh[symbol] = quote;
          }

          charts[symbol].data = prices[symbol];
          drawChart(symbol);
        }
      };
    }

    document.getElementById('loginBtn').addEventListener('click', () => {
      const token = prompt('Paste your Deriv API token:');
      if (token) connectWS(token.trim());
    });
  })();
  </script>
</body>
</html>
