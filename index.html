<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Deriv EMA Crossover</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
body {margin:0;font-family:sans-serif;background:#0f172a;color:#e5e7eb;}
header{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#111827;border-bottom:1px solid #1f2937;}
.controls button,select,input{margin-left:0.5rem;padding:0.4rem 0.6rem;border-radius:6px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;}
main{display:grid;grid-template-columns:240px 1fr;gap:1rem;padding:1rem;}
aside{background:#111827;padding:1rem;border-radius:8px;}
#chart{height:70vh;}
.feed{font-size:0.85rem;margin-top:1rem;max-height:200px;overflow-y:auto;background:#1f2937;padding:0.5rem;border-radius:6px;}
.feed .item{display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px dashed #374151;}
.buy{color:#16a34a;}.sell{color:#dc2626;}
</style>
</head>
<body>
<header>
  <div><strong>Deriv EMA Crossover</strong></div>
  <div class="controls">
    <button id="loginBtn">Login with Deriv</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <span id="accountChip" style="display:none;">âœ… Authorized</span>
  </div>
</header>
<main>
  <aside>
    <label>Volatility Index</label><br/>
    <select id="symbolSelect" disabled><option>Loading...</option></select><br/><br/>
    <label>EMA Fast</label><br/>
    <input id="emaFast" type="number" value="5" /><br/><br/>
    <label>EMA Slow</label><br/>
    <input id="emaSlow" type="number" value="20" /><br/><br/>
    <button id="applyBtn">Apply</button><br/><br/>
    <label><input type="checkbox" id="soundToggle" checked /> Sound on signal</label>
  </aside>
  <section>
    <div id="chart"></div>
    <div class="feed" id="feed"></div>
  </section>
</main>

<script>
const APP_ID = 99120;
const REDIRECT_URI = "https://eliakim-deriv.vercel.app/";
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const GRANULARITY = 60, HISTORY_COUNT = 500;

let ws, activeSymbol=null, emaFastPeriod=5, emaSlowPeriod=20;
let chart, candleSeries, emaFastSeries, emaSlowSeries, candleBuffer=[];

const el = {
  loginBtn: document.getElementById('loginBtn'),
  logoutBtn: document.getElementById('logoutBtn'),
  accountChip: document.getElementById('accountChip'),
  symbolSelect: document.getElementById('symbolSelect'),
  emaFast: document.getElementById('emaFast'),
  emaSlow: document.getElementById('emaSlow'),
  applyBtn: document.getElementById('applyBtn'),
  soundToggle: document.getElementById('soundToggle'),
  chart: document.getElementById('chart'),
  feed: document.getElementById('feed')
};

function parseParams(){
  const params=new URLSearchParams(window.location.search);
  const hash=new URLSearchParams(window.location.hash.replace(/^#/,''));
  const out={}; for(const [k,v] of params) out[k]=v; for(const [k,v] of hash) out[k]=v;
  return out;
}
function extractToken(parsed){
  for(const k of Object.keys(parsed)){
    if(/^token\d*$/.test(k) || ['token','access_token','auth_token','code'].includes(k)) return parsed[k];
  }
  return null;
}
function sanitizeURL(){history.replaceState({},document.title,location.pathname);}
function connectWS(token){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>send({authorize:token});
  ws.onmessage=onMessage;
}
function send(msg){if(ws && ws.readyState===1) ws.send(JSON.stringify(msg));}
function beep(){
  if(!el.soundToggle.checked) return;
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0.001,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.25,ctx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.15);
  o.start(); o.stop(ctx.currentTime+0.18);
}
function computeEMA(values, period){
  const alpha=2/(period+1), out=new Array(values.length).fill(null);
  if(values.length<period) return out;
  let sum=0; for(let i=0;i<period;i++) sum+=values[i];
  out[period-1]=sum/period;
  for(let i=period;i<values.length;i++){
    const prev=out[i-1]??values[i-1];
    out[i]=alpha*values[i]+(1-alpha)*prev;
  }
  return out;
}
function detectCrossover(pf,ps,f,s){
  if(pf==null||ps==null||f==null||s==null) return null;
  if(pf<ps && f>=s) return 'buy';
  if(pf>ps && f<=s) return 'sell';
  return null;
}
function initChart(){
  chart=LightweightCharts.createChart(el.chart,{layout:{background:{color:'#0f172a'},textColor:'#e5e7eb'},grid:{vertLines:{color:'#1f2937'},horzLines:{color:'#1f2937'}}});
  candleSeries=chart.addCandlestickSeries();
  emaFastSeries=chart.addLineSeries({color:'#22d3ee',lineWidth:2});
  emaSlowSeries=chart.addLineSeries({color:'#f59e0b',lineWidth:2});
}
function updateChart(){
  const data=candleBuffer.map(c=>({time:c.epoch,open:+c.open,high:+c.high,low:+c.low,close:+c.close}));
  candleSeries.setData(data);
  const closes=data.map(c=>c.close);
  const ef=computeEMA(closes,emaFastPeriod), es=computeEMA(closes,emaSlowPeriod);
  emaFastSeries.setData(data.map((c,i)=>({time:c.time,value:ef[i]})));
  emaSlowSeries.setData(data.map((c,i)=>({time:c.time,value:es[i]})));
  const i=data.length-1;
  const signal=detectCrossover(ef[i-1],es[i-1],ef[i],es[i]);
  if(signal){
    const item=document.createElement('div');
    item.className=`item ${signal}`;
    item.innerHTML=`<span>${new Date(data[i].time*1000).toLocaleTimeString()}</span>
                    <span>${activeSymbol} @ ${data[i].close}</span>
                    <span class="${signal}">${signal.toUpperCase()}</span>`;
    el.feed.prepend(item);
    beep();
  }
}
function setSymbol(symbol){
  activeSymbol=symbol;
  candleBuffer=[];
  send({ticks_history:symbol,adjust_start_time:1,count:HISTORY_COUNT,granularity:GRANULARITY,style:'candles',subscribe:1});
}
function onMessage(ev){
  const data=JSON.parse(ev.data);
  if(data.error) return console.error(data.error.message);
  if(data.msg_type==='authorize'){
    el.accountChip.style.display='inline';
    el.loginBtn.style.display='none';
    el.logoutBtn.style.display='inline';
    send({active_symbols:'full',product_type:'basic'});
  }
  if(data.msg_type==='active_symbols'){
    const syms=data.active_symbols.filter(s=>/Volatility/i.test(s.display_name));
    el.symbolSelect.innerHTML='';
    syms.forEach(s=>{
      const opt=document.createElement('option');
      opt.value=s.symbol; opt.textContent=s.display_name;
      el.symbolSelect.appendChild(opt);
    });
    el.symbolSelect.disabled=false;
    if(syms.length>0) setSymbol(syms[0].symbol);
  }
  if(data.msg_type==='candles' || data.msg_type==='ohlc'){
    const arr=data.candles || [data.ohlc];
    const arr = data.candles || [data.ohlc];
    arr.forEach(c => {
      const latest = {
        epoch: +c.epoch,
        open: +c.open, high: +c.high, low: +c.low, close: +c.close
      };
      const last = candleBuffer[candleBuffer.length - 1];
      if (last && last.epoch === latest.epoch) {
        candleBuffer[candleBuffer.length - 1] = latest;
      } else {
        candleBuffer.push(latest);
        if (candleBuffer.length > HISTORY_COUNT) candleBuffer.shift();
      }
    });
    updateChart();
  }
}

// ---------------------------
// Event listeners
// ---------------------------
el.symbolSelect.addEventListener('change', e => setSymbol(e.target.value));

el.applyBtn.addEventListener('click', () => {
  emaFastPeriod = parseInt(el.emaFast.value) || 5;
  emaSlowPeriod = parseInt(el.emaSlow.value) || 20;
  updateChart();
});

el.loginBtn.addEventListener('click', () => {
  const oauthUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
  window.location.href = oauthUrl;
});

el.logoutBtn.addEventListener('click', () => {
  location.href = location.pathname;
});

// ---------------------------
// Init
// ---------------------------
initChart();
const parsed = parseParams();
const token = extractToken(parsed);
if (token) {
  sanitizeURL();
  connectWS(token);
}
</script>
</body>
</html>
