<!-- Eliakim's Accumulator + EMA Crossover Dashboard -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Accumulator + EMA Crossover Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 1rem; }
    header { font-size: 1.5rem; margin-bottom: 1rem; }
    .controls label, .controls select, .controls input { display: block; margin: 0.5rem 0; }
    .status { margin-top: 1rem; padding: 1rem; background: #1f2937; border-radius: 8px; }
    .alert { color: #f87171; font-weight: bold; }
    .safe { color: #22c55e; }
    #chart { height: 60vh; margin-top: 1rem; }
    .feed { font-size: 0.85rem; margin-top: 1rem; max-height: 150px; overflow-y: auto; background: #1f2937; padding: 0.5rem; border-radius: 6px; }
    .feed .item { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px dashed #374151; }
    .buy { color: #16a34a; } .sell { color: #dc2626; }
  </style>
</head>
<body>
  <header>üìà Accumulator + EMA Crossover Dashboard</header>
  <div class="controls">
    <label>Symbol</label>
    <select id="symbolSelect"><option>Loading...</option></select>

    <label>Growth Rate (%)</label>
    <input type="number" id="growthInput" value="3" min="1" max="5" />

    <label>EMA Fast</label>
    <input type="number" id="emaFast" value="5" />

    <label>EMA Slow</label>
    <input type="number" id="emaSlow" value="20" />

    <button id="startBtn">Start Monitoring</button>
  </div>

  <div class="status">
    <div>üìä Price: <span id="price">--</span></div>
    <div>üìâ Lower Barrier: <span id="lowerBarrier">--</span></div>
    <div>üìà Upper Barrier: <span id="upperBarrier">--</span></div>
    <div id="alertMsg"></div>
  </div>

  <div id="chart"></div>
  <div class="feed" id="feed"></div>

<script>
const APP_ID = 99120;
const API_TOKEN = "lKcYGLpmaAMgUkH";
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const GRANULARITY = 60, HISTORY_COUNT = 500;

let ws, activeSymbol = null, candleBuffer = [];
let chart, candleSeries, emaFastSeries, emaSlowSeries;
let growthRate = 3, emaFastPeriod = 5, emaSlowPeriod = 20;
let lowerBarrier = null, upperBarrier = null;

const el = {
  symbolSelect: document.getElementById('symbolSelect'),
  growthInput: document.getElementById('growthInput'),
  emaFast: document.getElementById('emaFast'),
  emaSlow: document.getElementById('emaSlow'),
  startBtn: document.getElementById('startBtn'),
  price: document.getElementById('price'),
  lowerBarrier: document.getElementById('lowerBarrier'),
  upperBarrier: document.getElementById('upperBarrier'),
  alertMsg: document.getElementById('alertMsg'),
  chart: document.getElementById('chart'),
  feed: document.getElementById('feed')
};

function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => send({ authorize: API_TOKEN });
  ws.onmessage = onMessage;
}
function send(msg) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(msg));
}

function computeEMA(values, period) {
  const alpha = 2 / (period + 1), out = new Array(values.length).fill(null);
  if (values.length < period) return out;
  out[period - 1] = values.slice(0, period).reduce((a, b) => a + b) / period;
  for (let i = period; i < values.length; i++) {
    out[i] = alpha * values[i] + (1 - alpha) * out[i - 1];
  }
  return out;
}

function detectCrossover(pf, ps, f, s) {
  if (pf == null || ps == null || f == null || s == null) return null;
  if (pf < ps && f >= s) return 'buy';
  if (pf > ps && f <= s) return 'sell';
  return null;
}

function initChart() {
  chart = LightweightCharts.createChart(el.chart, {
    layout: { background: { color: '#0f172a' }, textColor: '#e5e7eb' },
    grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } }
  });
  candleSeries = chart.addCandlestickSeries();
  emaFastSeries = chart.addLineSeries({ color: '#16a34a', lineWidth: 2 });
  emaSlowSeries = chart.addLineSeries({ color: '#dc2626', lineWidth: 2 });
}

function updateChart() {
  const data = candleBuffer.map(c => ({
    time: c.epoch, open: +c.open, high: +c.high, low: +c.low, close: +c.close
  }));
  candleSeries.setData(data);
  const closes = data.map(c => c.close);
  const ef = computeEMA(closes, emaFastPeriod);
  const es = computeEMA(closes, emaSlowPeriod);
  emaFastSeries.setData(data.map((c, i) => ({ time: c.time, value: ef[i] })));
  emaSlowSeries.setData(data.map((c, i) => ({ time: c.time, value: es[i] })));

  const markers = [];
  for (let i = 1; i < data.length; i++) {
    const signal = detectCrossover(ef[i - 1], es[i - 1], ef[i], es[i]);
    if (signal) {
      markers.push({
        time: data[i].time,
        position: signal === 'buy' ? 'belowBar' : 'aboveBar',
        color: '#a855f7',
        shape: 'circle',
        text: signal.toUpperCase()
      });
      const item = document.createElement('div');
      item.className = `item ${signal}`;
      item.innerHTML = `<span>${new Date(data[i].time * 1000).toLocaleTimeString()}</span>
                        <span>${activeSymbol}</span>
                        <span class="${signal}">${signal.toUpperCase()}</span>`;
      el.feed.prepend(item);
    }
  }
  candleSeries.setMarkers(markers);
}

function setSymbol(symbol) {
  activeSymbol = symbol;
  candleBuffer = [];
  send({
    ticks_history: symbol,
    adjust_start_time: 1,
    count: HISTORY_COUNT,
    granularity: GRANULARITY,
    style: 'candles',
    subscribe: 1
  });
  send({ ticks: symbol, subscribe: 1 });
}

function onMessage(ev) {
  const data = JSON.parse(ev.data);
  if (data.error) return console.error(data.error.message);

  if (data.msg_type === 'authorize') {
    send({ active_symbols: 'brief', product_type: 'basic' });
  }

  if (data.msg_type === 'active_symbols') {
    const syms = data.active_symbols.filter(s => /Volatility/i.test(s.display_name));
    el.symbolSelect.innerHTML = '';
    syms.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.symbol;
      opt.textContent = s.display_name;
      el.symbolSelect.appendChild(opt);
    });
    activeSymbol = syms[0].symbol;
  }

  // COMBINED CODE PART
  if (data.msg_type === 'candles' || data.msg_type === 'ohlc') {
    const arr = data.candles || [data.ohlc];
    arr.forEach(c => {
      const latest = {
        epoch: +c.epoch,
        open: +c.open,
        high: +c.high,
        low: +c.low,
        close: +c.close
      };
      const last = candleBuffer[candleBuffer.length - 1];
      if (last && last.epoch === latest.epoch) {
        candleBuffer[candleBuffer.length - 1] = latest;
      } else {
        candleBuffer.push(latest);
        if (candleBuffer.length > HISTORY_COUNT) candleBuffer.shift();
      }
    });
    updateChart();
  }
  // END COMBINED

  if (data.msg_type === 'tick') {
    const price = parseFloat(data.tick.quote);
    el.price.textContent = price.toFixed(5);

    const range = growthRate / 100;
    lowerBarrier = price * (1 - range);
    upperBarrier = price * (1 + range);
    el.lowerBarrier.textContent = lowerBarrier.toFixed(5);
    el.upperBarrier.textContent = upperBarrier.toFixed(5);

    const proximity = 0.005 * price; // 0.5% proximity alert
    if (Math.abs(price - lowerBarrier) <= proximity) {
      el.alertMsg.innerHTML = `<div class="alert">‚ö†Ô∏è Near LOWER barrier</div>`;
    } else if (Math.abs(price - upperBarrier) <= proximity) {
      el.alertMsg.innerHTML = `<div class="alert">‚ö†Ô∏è Near UPPER barrier</div>`;
    } else {
      el.alertMsg.innerHTML = `<div class="safe">‚úÖ Price safely within range</div>`;
    }
  }
}

el.startBtn.addEventListener('click', () => {
  growthRate = parseFloat(el.growthInput.value) || 3;
  emaFastPeriod = parseInt(el.emaFast.value) || 5;
  emaSlowPeriod = parseInt(el.emaSlow.value) || 20;
  activeSymbol = el.symbolSelect.value;
  candleBuffer = [];
  el.feed.innerHTML = '';
  setSymbol(activeSymbol);
});

initChart();
connectWS();
</script>
</body>
</html>
