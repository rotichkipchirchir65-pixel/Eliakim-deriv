<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Eliakim WiFi Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { background: #0b0b0b; color: #00ffcc; font-family: monospace; margin: 0; padding: 20px; }
    h1 { font-size: 20px; margin-bottom: 10px; }
    section { margin-bottom: 30px; border: 1px solid #222; padding: 15px; border-radius: 10px; background: #111; }
    input, button { background: #222; color: #00ffcc; border: 1px solid #333; padding: 8px; margin: 5px; border-radius: 6px; }
    button:hover { background: #00ffcc; color: #000; }
    .network { border-top: 1px solid #333; padding: 10px 0; }
    .trusted { color: #32ff7e; }
    .suspicious { color: #ff5c33; }
    .muted { color: #7adbc9; }
    .pw { user-select: all; word-break: break-word; }
    canvas { margin-top: 10px; }
    #reader { width: 300px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üì° Eliakim WiFi Intelligence Dashboard</h1>

  <section>
    <h2>üìç Location & Nearby Hotspots</h2>
    <button onclick="getLocation()">Allow Location</button>
    <span id="loc" class="muted">‚Äî</span>
    <div id="locError" class="muted"></div>
    <br>
    <button onclick="fetchHotspots()">Fetch Public Hotspots</button>
    <div id="hotspots"></div>
  </section>

  <section>
    <h2>üîë Add WiFi Credentials</h2>
    <input id="ssid" placeholder="SSID" />
    <input id="password" placeholder="Password" />
    <button onclick="savePassword()">Save</button>
    <button onclick="generateQR()">Generate QR</button>
    <canvas id="qrCanvas"></canvas>
  </section>

  <section>
    <h2>üì∑ Scan QR to Import</h2>
    <div id="reader"></div>
    <button onclick="startScanner()">Start Scanner</button>
    <button onclick="stopScanner()">Stop Scanner</button>
  </section>

  <section>
    <h2>üîê Vault</h2>
    <input id="vaultPass" type="password" placeholder="Vault passphrase" />
    <button onclick="unlockVault()">Unlock Vault</button>
    <span id="vaultState" class="muted">Locked</span>
    <div id="vault"></div>
  </section>

  <script>
    const storeKey = "eliakim.wifi.vault";
    let vault = [];
    let html5QrCode = null;
    let lastPos = null;

    function getLocation() {
      navigator.permissions.query({ name: 'geolocation' }).then(result => {
        if (result.state === 'denied') {
          document.getElementById("locError").innerHTML = "Location blocked. Enable it in browser settings.";
        } else {
          navigator.geolocation.getCurrentPosition(pos => {
            lastPos = pos.coords;
            document.getElementById("loc").textContent = `üìç ${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
            document.getElementById("locError").textContent = "";
          }, err => {
            document.getElementById("locError").textContent = "Location error: " + err.message;
          });
        }
      });
    }

    function fetchHotspots() {
      const box = document.getElementById("hotspots");
      box.innerHTML = "<div class='muted'>Loading‚Ä¶</div>";
      const demo = [
        { ssid: "NandiHub_Free", security: "Open", strength: -55, password: "" },
        { ssid: "Chemundu_School", security: "WPA2", strength: -62, password: "school2025" }
      ];
      box.innerHTML = demo.map(n => `
        <div class="network">
          <strong>${n.ssid}</strong> <span class="${n.password ? 'trusted' : 'suspicious'}">(${n.security}, ${n.strength} dBm)</span><br>
          ${n.password ? `<span class="pw">${n.password}</span> <button onclick="copy('${n.password}')">Copy</button>` : `<span class="muted">No password</span>`}
        </div>
      `).join("");
    }

    function copy(text) {
      navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard"));
    }

    function savePassword() {
      const ssid = document.getElementById("ssid").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!ssid || !password) return;
      const existing = vault.find(v => v.ssid === ssid);
      if (existing) existing.password = password;
      else vault.push({ ssid, password });
      persistVault(); renderVault();
    }

    function generateQR() {
      const ssid = document.getElementById("ssid").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!ssid || !password) return;
      const payload = btoa(JSON.stringify({ ssid, password }));
      QRCode.toCanvas(document.getElementById("qrCanvas"), payload, { color: { dark: "#00ffcc", light: "#0b0b0b" }, width: 200 });
    }

    function startScanner() {
      if (html5QrCode) return;
      html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, text => {
        try {
          const data = JSON.parse(atob(text));
          const existing = vault.find(v => v.ssid === data.ssid);
          if (existing) existing.password = data.password;
          else vault.push({ ssid: data.ssid, password: data.password });
          persistVault(); renderVault();
        } catch (e) {}
      });
    }

    function stopScanner() {
      if (!html5QrCode) return;
      html5QrCode.stop().then(() => { html5QrCode.clear(); html5QrCode = null; });
    }

    function renderVault() {
      const box = document.getElementById("vault");
      if (!vault.length) {
        box.innerHTML = "<div class='muted'>Vault is empty.</div>";
        return;
      }
      box.innerHTML = vault.map(v => `
        <div class="network">
          <strong>${v.ssid}</strong><br>
          <span class="pw" id="pw-${v.ssid}">${v.password}</span>
          <button onclick="copy('${v.password}')">Copy</button>
        </div>
      `).join("");
    }

    async function persistVault() {
      const pass = document.getElementById("vaultPass").value;
      if (!pass) return alert("Set a vault passphrase first.");
      const enc = new TextEncoder().encode(JSON.stringify(vault));
      const key = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pass));
      const encrypted = enc.map((b, i) => b ^ new Uint8Array(key)[i % 32]);
      localStorage.setItem(storeKey, btoa(String.fromCharCode(...encrypted)));
    }

    async function unlockVault() {
      const pass = document.getElementById("vaultPass").value;
      const raw = localStorage.getItem(storeKey);
      if (!raw) {
        vault = [];
        document.getElementById("vaultState").textContent = "Unlocked (new)";
        renderVault();
        return;
      }
      try {
        const encrypted = Uint8Array.from(atob(raw), c => c.charCodeAt(0));
        const key = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pass));
        const decrypted = encrypted.map((b, i) => b ^ new Uint8Array(key)[i % 32]);
        vault = JSON.parse(new TextDecoder().decode(decrypted));
        document.getElementById("vaultState").textContent = "Unlocked";
        renderVault();
      } catch (e) {
        document.getElementById("vaultState").textContent = "Unlock failed";
      }
    }

    // Initial vault render
    renderVault();
  </script>
</body>
</html>
