<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Accumulator + EMA Crossover Dashboard (Deriv OAuth2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 1rem; }
    header { font-size: 1.5rem; margin-bottom: 1rem; }
    .controls label, .controls select, .controls input { display: block; margin: 0.5rem 0; }
    .status { margin-top: 1rem; padding: 1rem; background: #1f2937; border-radius: 8px; }
    .alert { color: #f87171; font-weight: bold; }
    .safe { color: #22c55e; }
    #chart { height: 60vh; margin-top: 1rem; }
    .feed { font-size: 0.85rem; margin-top: 1rem; max-height: 150px; overflow-y: auto; background: #1f2937; padding: 0.5rem; border-radius: 6px; }
    .feed .item { display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px dashed #374151; }
    .buy { color: #16a34a; } .sell { color: #dc2626; }
    .multi-symbols { margin-top: 0.5rem; }
    .hidden { display: none !important; }
    .oauth-login { background: #1f2937; padding: 1rem; border-radius: 10px; max-width: 400px; margin: 2rem auto; text-align:center;}
    .oauth-login button { padding: 0.7rem 1.5rem; border-radius: 6px; border: none; background: #1a73e8; color: white; font-weight: bold; font-size:1rem; cursor: pointer; margin-bottom:0.7rem;}
    .oauth-login .info { font-size: 0.85rem; color: #fbbf24; margin-top: 0.3rem;}
    .login-error { color: #f87171; margin-top: 0.5rem;}
    @media (max-width: 600px) {
      header { font-size: 1.1rem; }
      #chart { height: 40vh; }
      .status, .feed, .controls { padding: 0.5rem; }
      .oauth-login { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <header>📈 Accumulator + EMA Crossover Dashboard</header>

  <!-- OAUTH LOGIN -->
  <div id="oauthLoginBox" class="oauth-login">
    <button id="oauthLoginBtn">Login with Deriv</button>
    <div class="info">
      You will be redirected to Deriv to authorize this app.<br>
      No password required, safe for any account.<br>
      <br>
      <b>Note:</b> Your token is only used in your browser, never stored by us.
    </div>
    <div class="login-error" id="loginError"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <div class="controls">
      <label>Symbols (hold Ctrl/⌘ for multi-select)</label>
      <select id="symbolSelect" multiple size="3"><option>Loading...</option></select>

      <label>Growth Rate (%)</label>
      <input type="number" id="growthInput" value="3" min="1" max="5" />

      <label>EMA Fast</label>
      <input type="number" id="emaFast" value="5" />

      <label>EMA Slow</label>
      <input type="number" id="emaSlow" value="20" />

      <button id="startBtn">Start Monitoring</button>
      <button id="logoutBtn" style="margin-left:1rem;background:#dc2626;">Logout</button>
    </div>

    <div class="status">
      <div id="connectionStatus">🔄 Connecting to Deriv...</div>
      <div class="multi-symbols" id="multiStatus"></div>
      <div>📊 Price: <span id="price">--</span></div>
      <div>📉 Lower Barrier: <span id="lowerBarrier">--</span></div>
      <div>📈 Upper Barrier: <span id="upperBarrier">--</span></div>
      <div id="alertMsg"></div>
    </div>

    <div id="chart"></div>
    <div class="feed" id="feed"></div>
  </div>

  <audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
const APP_ID = 99120;
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;
const GRANULARITY = 60, HISTORY_COUNT = 500;
const REDIRECT_URI = window.location.origin + window.location.pathname;

const el = {
  oauthLoginBox: document.getElementById('oauthLoginBox'),
  oauthLoginBtn: document.getElementById('oauthLoginBtn'),
  loginError: document.getElementById('loginError'),
  dashboard: document.getElementById('dashboard'),
  symbolSelect: document.getElementById('symbolSelect'),
  growthInput: document.getElementById('growthInput'),
  emaFast: document.getElementById('emaFast'),
  emaSlow: document.getElementById('emaSlow'),
  startBtn: document.getElementById('startBtn'),
  price: document.getElementById('price'),
  lowerBarrier: document.getElementById('lowerBarrier'),
  upperBarrier: document.getElementById('upperBarrier'),
  alertMsg: document.getElementById('alertMsg'),
  chart: document.getElementById('chart'),
  feed: document.getElementById('feed'),
  connectionStatus: document.getElementById('connectionStatus'),
  multiStatus: document.getElementById('multiStatus'),
  alertSound: document.getElementById('alertSound'),
  logoutBtn: document.getElementById('logoutBtn')
};

let apiToken = null;
let wsSockets = {};
let candleBuffers = {};
let growthRate = 3, emaFastPeriod = 5, emaSlowPeriod = 20;
let barriers = {};

// Get OAuth2 token from URL (?token1=xxx)
function getTokenFromURL() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('token1');
}

// Helper: play sound alert
function playAlertSound() {
  try {
    el.alertSound.currentTime = 0;
    el.alertSound.play();
  } catch(e) {}
}

// EMA calculation
function computeEMA(values, period) {
  const alpha = 2 / (period + 1), out = new Array(values.length).fill(null);
  if (values.length < period) return out;
  out[period - 1] = values.slice(0, period).reduce((a, b) => a + b) / period;
  for (let i = period; i < values.length; i++) {
    out[i] = alpha * values[i] + (1 - alpha) * out[i - 1];
  }
  return out;
}

function detectCrossover(pf, ps, f, s) {
  if (pf == null || ps == null || f == null || s == null) return null;
  if (pf < ps && f >= s) return 'buy';
  if (pf > ps && f <= s) return 'sell';
  return null;
}

function initChart() {
  chart = LightweightCharts.createChart(el.chart, {
    layout: { background: { color: '#0f172a' }, textColor: '#e5e7eb' },
    grid: { vertLines: { color: '#1f2937' }, horzLines: { color: '#1f2937' } }
  });
  candleSeries = chart.addCandlestickSeries();
  emaFastSeries = chart.addLineSeries({ color: '#16a34a', lineWidth: 2 });
  emaSlowSeries = chart.addLineSeries({ color: '#dc2626', lineWidth: 2 });
}

function updateChart(symbol) {
  const buffer = candleBuffers[symbol];
  if (!buffer || !buffer.length) return;
  const data = buffer.map(c => ({
    time: c.epoch, open: +c.open, high: +c.high, low: +c.low, close: +c.close
  }));
  candleSeries.setData(data);
  const closes = data.map(c => c.close);
  const ef = computeEMA(closes, emaFastPeriod);
  const es = computeEMA(closes, emaSlowPeriod);
  emaFastSeries.setData(data.map((c, i) => ({ time: c.time, value: ef[i] })));
  emaSlowSeries.setData(data.map((c, i) => ({ time: c.time, value: es[i] })));

  const markers = [];
  for (let i = 1; i < data.length; i++) {
    const signal = detectCrossover(ef[i - 1], es[i - 1], ef[i], es[i]);
    if (signal) {
      markers.push({
        time: data[i].time,
        position: signal === 'buy' ? 'belowBar' : 'aboveBar',
        color: '#a855f7',
        shape: 'circle',
        text: signal.toUpperCase()
      });
      addFeedItem(symbol, data[i].time, signal);
      playAlertSound();
    }
  }
  candleSeries.setMarkers(markers);
}

function addFeedItem(symbol, epoch, signal) {
  const item = document.createElement('div');
  item.className = `item ${signal}`;
  item.innerHTML = `<span>${new Date(epoch * 1000).toLocaleTimeString()}</span>
                    <span>${symbol}</span>
                    <span class="${signal}">${signal.toUpperCase()}</span>`;
  el.feed.prepend(item);
}

function updateMultiStatus(statusMap) {
  let str = "";
  Object.entries(statusMap).forEach(([symbol, status]) => {
    str += `<div>${symbol}: ${status}</div>`;
  });
  el.multiStatus.innerHTML = str;
}

function startMonitoring(symbols) {
  Object.values(wsSockets).forEach(socket => {
    try { socket.close(); } catch(e) {}
  });
  wsSockets = {};
  candleBuffers = {};
  barriers = {};
  el.feed.innerHTML = '';
  el.price.textContent = '--';
  el.lowerBarrier.textContent = '--';
  el.upperBarrier.textContent = '--';
  el.alertMsg.innerHTML = '';
  el.multiStatus.innerHTML = '';

  symbols.forEach((symbol, idx) => {
    candleBuffers[symbol] = [];
    let ws = new WebSocket(WS_URL);
    wsSockets[symbol] = ws;

    ws.onopen = () => {
      ws.send(JSON.stringify({ authorize: apiToken }));
      if (idx === 0) el.connectionStatus.textContent = `🔄 Connecting to Deriv...`;
    };

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.error) {
        el.connectionStatus.textContent = `❌ Connection error: ${data.error.message}`;
        updateMultiStatus({ [symbol]: "❌ Error" });
        return;
      }

      if (data.msg_type === 'authorize') {
        if (idx === 0) {
          el.connectionStatus.textContent = `✅ Connected as ${data.authorize.loginid}`;
        }
        ws.send(JSON.stringify({ active_symbols: 'brief', product_type: 'basic' }));
      }

      if (data.msg_type === 'active_symbols') {
        if (idx === 0) {
          const syms = data.active_symbols.filter(s => /Volatility/i.test(s.display_name));
          el.symbolSelect.innerHTML = '';
          syms.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.symbol;
            opt.textContent = s.display_name;
            el.symbolSelect.appendChild(opt);
          });
        }
        ws.send(JSON.stringify({
          ticks_history: symbol,
          adjust_start_time: 1,
          count: HISTORY_COUNT,
          granularity: GRANULARITY,
          style: 'candles',
          subscribe: 1
        }));
        ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
      }

      if (data.msg_type === 'candles' || data.msg_type === 'ohlc') {
        const arr = data.candles || [data.ohlc];
        arr.forEach(c => {
          const latest = {
            epoch: +c.epoch,
            open: +c.open,
            high: +c.high,
            low: +c.low,
            close: +c.close
          };
          const buffer = candleBuffers[symbol];
          const last = buffer[buffer.length - 1];
          if (last && last.epoch === latest.epoch) {
            buffer[buffer.length - 1] = latest;
          } else {
            buffer.push(latest);
            if (buffer.length > HISTORY_COUNT) buffer.shift();
          }
        });
        if (idx === 0) updateChart(symbol);
      }

      if (data.msg_type === 'tick') {
        const price = parseFloat(data.tick.quote);
        barriers[symbol] = barriers[symbol] || {};
        const range = growthRate / 100;
        barriers[symbol].lower = price * (1 - range);
        barriers[symbol].upper = price * (1 + range);

        if (idx === 0) {
          el.price.textContent = price.toFixed(5);
          el.lowerBarrier.textContent = barriers[symbol].lower.toFixed(5);
          el.upperBarrier.textContent = barriers[symbol].upper.toFixed(5);

          const proximity = 0.005 * price;
          if (Math.abs(price - barriers[symbol].lower) <= proximity) {
            el.alertMsg.innerHTML = `<div class="alert">⚠️ Near LOWER barrier</div>`;
            playAlertSound();
          } else if (Math.abs(price - barriers[symbol].upper) <= proximity) {
            el.alertMsg.innerHTML = `<div class="alert">⚠️ Near UPPER barrier</div>`;
            playAlertSound();
          } else {
            el.alertMsg.innerHTML = `<div class="safe">✅ Price safely within range</div>`;
          }
        }
        updateMultiStatus({ [symbol]: `Live: ${price.toFixed(5)}` });
      }
    };

    ws.onerror = () => {
      updateMultiStatus({ [symbol]: "❌ WebSocket error" });
    };
  });
}

// OAUTH LOGIN button
el.oauthLoginBtn.onclick = function() {
  const url = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=${REDIRECT_URI}`;
  window.location.href = url;
};

// LOGOUT button
el.logoutBtn.onclick = function() {
  apiToken = null;
  Object.values(wsSockets).forEach(socket => {
    try { socket.close(); } catch(e) {}
  });
  wsSockets = {};
  el.dashboard.classList.add('hidden');
  el.oauthLoginBox.classList.remove('hidden');
  window.history.replaceState({}, document.title, REDIRECT_URI); // Remove token from URL
};

// On load: check token
window.onload = function() {
  apiToken = getTokenFromURL();
  if (apiToken) {
    el.oauthLoginBox.classList.add('hidden');
    el.dashboard.classList.remove('hidden');
    initChart();
    startMonitoring(['R_50']); // Default symbol for initial load
  } else {
    el.oauthLoginBox.classList.remove('hidden');
    el.dashboard.classList.add('hidden');
  }
};

el.startBtn.addEventListener('click', () => {
  growthRate = parseFloat(el.growthInput.value) || 3;
  emaFastPeriod = parseInt(el.emaFast.value) || 5;
  emaSlowPeriod = parseInt(el.emaSlow.value) || 20;
  const selectedSymbols = Array.from(el.symbolSelect.selectedOptions).map(opt => opt.value);
  if (selectedSymbols.length === 0) {
    alert('Please select at least one symbol.');
    return;
  }
  initChart();
  startMonitoring(selectedSymbols);
});
</script>
</body>
</html>
