<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Deriv Accumulator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 1rem; }
    header { font-size: 1.5rem; margin-bottom: 1rem; }
    .controls label, .controls select, .controls input { display: block; margin: 0.5rem 0; }
    .status { margin-top: 1rem; padding: 1rem; background: #1f2937; border-radius: 8px; }
    .alert { color: #f87171; font-weight: bold; }
    .safe { color: #22c55e; }
  </style>
</head>
<body>
  <header>📈 Live Accumulator Dashboard</header>
  <div class="controls">
    <label>Symbol</label>
    <select id="symbolSelect"><option>Loading...</option></select>

    <label>Stake ($)</label>
    <input type="number" id="stakeInput" value="1" />

    <label>Growth Rate (%)</label>
    <input type="number" id="growthInput" value="2" min="1" max="5" />

    <label>Take Profit ($)</label>
    <input type="number" id="tpInput" value="5" />

    <button id="startBtn">Start Trade</button>
  </div>

  <div class="status" id="statusBox">
    <div>🔐 Status: <span id="authStatus">Connecting...</span></div>
    <div>📊 Price: <span id="price">--</span></div>
    <div>💰 Stake Growth: <span id="stakeGrowth">--</span></div>
    <div>📉 Lower Barrier: <span id="lowerBarrier">--</span></div>
    <div>📈 Upper Barrier: <span id="upperBarrier">--</span></div>
    <div>📄 Contract ID: <span id="contractId">--</span></div>
    <div id="alertMsg"></div>
  </div>

<script>
const APP_ID = 99120;
const API_TOKEN = "lKcYGLpmaAMgUkH";
const WS_URL = `wss://ws.derivws.com/websockets/v3?app_id=${APP_ID}`;

let ws, activeSymbol = null, contractId = null;
let stake = 1, growthRate = 2, takeProfit = 5;
let tickCount = 0, lowerBarrier = null, upperBarrier = null;

const el = {
  symbolSelect: document.getElementById('symbolSelect'),
  stakeInput: document.getElementById('stakeInput'),
  growthInput: document.getElementById('growthInput'),
  tpInput: document.getElementById('tpInput'),
  startBtn: document.getElementById('startBtn'),
  authStatus: document.getElementById('authStatus'),
  price: document.getElementById('price'),
  stakeGrowth: document.getElementById('stakeGrowth'),
  lowerBarrier: document.getElementById('lowerBarrier'),
  upperBarrier: document.getElementById('upperBarrier'),
  contractId: document.getElementById('contractId'),
  alertMsg: document.getElementById('alertMsg')
};

function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.onopen = () => send({ authorize: API_TOKEN });
  ws.onmessage = onMessage;
}

function send(msg) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(msg));
}

function onMessage(ev) {
  const data = JSON.parse(ev.data);
  if (data.error) return console.error(data.error.message);

  if (data.msg_type === 'authorize') {
    el.authStatus.textContent = "✅ Authorized";
    send({ active_symbols: 'brief', product_type: 'basic' });
  }

  if (data.msg_type === 'active_symbols') {
    const syms = data.active_symbols.filter(s => /Volatility/i.test(s.display_name));
    el.symbolSelect.innerHTML = '';
    syms.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.symbol;
      opt.textContent = s.display_name;
      el.symbolSelect.appendChild(opt);
    });
    activeSymbol = syms[0].symbol;
  }

  if (data.msg_type === 'tick') {
    const price = parseFloat(data.tick.quote);
    el.price.textContent = price.toFixed(5);
    tickCount++;

    const growthFactor = 1 + (growthRate / 100);
    const grownStake = stake * Math.pow(growthFactor, tickCount);
    el.stakeGrowth.textContent = `$${grownStake.toFixed(2)}`;

    if (price <= lowerBarrier || price >= upperBarrier) {
      el.alertMsg.innerHTML = `<div class="alert">🚨 Barrier breached! Trade ended.</div>`;
    } else {
      el.alertMsg.innerHTML = `<div class="safe">✅ Within barrier range</div>`;
    }
  }

  if (data.msg_type === 'buy') {
    contractId = data.buy.contract_id;
    el.contractId.textContent = contractId;
    send({ ticks: activeSymbol, subscribe: 1 });
  }

  if (data.msg_type === 'proposal_open_contract') {
    const status = data.proposal_open_contract.status;
    if (status === 'won' || status === 'lost') {
      el.alertMsg.innerHTML = `<div class="alert">💥 Contract ${status.toUpperCase()}</div>`;
    }
  }
}

el.startBtn.addEventListener('click', () => {
  stake = parseFloat(el.stakeInput.value) || 1;
  growthRate = parseFloat(el.growthInput.value) || 2;
  takeProfit = parseFloat(el.tpInput.value) || 5;
  activeSymbol = el.symbolSelect.value;

  tickCount = 0;
  el.alertMsg.textContent = '';
  el.stakeGrowth.textContent = `$${stake.toFixed(2)}`;
  el.contractId.textContent = '--';

  send({ forget_all: 1 });

  // Simulate barrier range (±X% from current price)
  send({ ticks: activeSymbol });
  ws.onmessage = (ev) => {
    const data = JSON.parse(ev.data);
    if (data.msg_type === 'tick') {
      const price = parseFloat(data.tick.quote);
      lowerBarrier = price * (1 - growthRate / 100);
      upperBarrier = price * (1 + growthRate / 100);
      el.lowerBarrier.textContent = lowerBarrier.toFixed(5);
      el.upperBarrier.textContent = upperBarrier.toFixed(5);

      send({
        buy: 1,
        price: stake,
        parameters: {
          amount: stake,
          basis: "stake",
          contract_type: "ACCUMULATOR",
          currency: "USD",
          symbol: activeSymbol,
          growth_rate: growthRate,
          take_profit: takeProfit
        }
      });

      ws.onmessage = onMessage;
    }
  };
});

connectWS();
</script>
</body>
</html>
